<!DOCTYPE html>
<html dir="rtl" lang="fa">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RSM Helper</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.6;
            padding: 0;
            margin: 0;
        }
        
        .container {
            max-width: 100%;
            padding: 20px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            padding: 20px 0;
            background-color: #0088cc;
            color: white;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .card {
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        
        .btn {
            display: block;
            width: 100%;
            padding: 12px;
            background-color: #0088cc;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin-top: 10px;
            text-align: center;
        }
        
        .btn:hover {
            background-color: #006da3;
        }
        
        .btn-secondary {
            background-color: #6c757d;
        }
        
        .btn-secondary:hover {
            background-color: #5a6268;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }
        
        .hidden {
            display: none;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
        }
        
        .error {
            background-color: #ffebee;
            color: #c62828;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
        }
        
        .success {
            background-color: #e8f5e9;
            color: #2e7d32;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
        }
        
        .page {
            display: none;
        }
        
        .active {
            display: block;
        }
        
        .nav {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
        }
        
        .admin-info {
            background-color: #e3f2fd;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- صفحه لودینگ -->
        <div id="loading" class="loading">
            <p>در حال بارگذاری...</p>
        </div>
        
        <!-- صفحه خطا برای مرورگر معمولی -->
        <div id="browser-error" class="page card error">
            <h2>خطا</h2>
            <p>این مینی‌اپ فقط داخل تلگرام کار می‌کند.</p>
        </div>
        
        <!-- پنل ادمین -->
        <div id="admin-panel" class="page">
            <div class="header">
                <h1>پنل مدیریت</h1>
            </div>
            
            <div id="admin-info" class="admin-info">
                <!-- اطلاعات ادمین اینجا نمایش داده می‌شود -->
            </div>
            
            <div class="card">
                <button id="btn-add-admin" class="btn">افزودن ادمین</button>
                <button id="btn-decide-request" class="btn">تایید/رد درخواست</button>
            </div>
            
            <!-- فرم افزودن ادمین -->
            <div id="form-add-admin" class="page card hidden">
                <h2>افزودن ادمین جدید</h2>
                <div class="form-group">
                    <label for="admin-nick">نام گیم:</label>
                    <input type="text" id="admin-nick" required>
                </div>
                <div class="form-group">
                    <label for="admin-referral">رفرال:</label>
                    <input type="text" id="admin-referral" required>
                </div>
                <div class="form-group">
                    <label for="admin-telegram-id">آیدی عددی تلگرام:</label>
                    <input type="number" id="admin-telegram-id" required>
                </div>
                <div class="form-group">
                    <label for="admin-rank">رنک:</label>
                    <select id="admin-rank" required>
                        <option value="">انتخاب کنید</option>
                        <option value="Support Manager">Support Manager</option>
                        <option value="Support Advisor">Support Advisor</option>
                        <option value="Support Director">Support Director</option>
                        <option value="Support Warden">Support Warden</option>
                    </select>
                </div>
                <button id="btn-submit-admin" class="btn">ثبت ادمین</button>
                <button id="btn-back-from-add-admin" class="btn btn-secondary">بازگشت</button>
            </div>
            
            <!-- فرم تایید/رد درخواست -->
            <div id="form-decide-request" class="page card hidden">
                <h2>تایید/رد درخواست</h2>
                <div class="form-group">
                    <label for="request-nick">نام گیم:</label>
                    <input type="text" id="request-nick" required>
                </div>
                <div class="form-group">
                    <label for="request-referral">رفرال:</label>
                    <input type="text" id="request-referral" required>
                </div>
                <div class="form-group">
                    <label for="request-telegram-id">آیدی عددی تلگرام:</label>
                    <input type="number" id="request-telegram-id" required>
                </div>
                <div class="form-group">
                    <label for="request-status">نوع درخواست:</label>
                    <select id="request-status" required>
                        <option value="">انتخاب کنید</option>
                        <option value="approved">تایید</option>
                        <option value="rejected">رد</option>
                    </select>
                </div>
                <div id="reason-field" class="form-group hidden">
                    <label for="request-reason">دلیل رد:</label>
                    <textarea id="request-reason" required></textarea>
                </div>
                <div id="tester-field" class="form-group hidden">
                    <label for="request-tester">مسئول تست:</label>
                    <select id="request-tester">
                        <option value="">انتخاب کنید</option>
                    </select>
                </div>
                <button id="btn-submit-decision" class="btn">ثبت تصمیم</button>
                <button id="btn-back-from-decide" class="btn btn-secondary">بازگشت</button>
            </div>
        </div>
        
        <!-- پنل کاربری -->
        <div id="user-panel" class="page">
            <div class="header">
                <h1>سامانه استعلام درخواست</h1>
            </div>
            
            <div class="card">
                <p>کاربر گرامی، برای استعلام درخواست خود از دکمه زیر استفاده کنید.</p>
                <button id="btn-query-request" class="btn">استعلام درخواست</button>
            </div>
            
            <!-- فرم استعلام -->
            <div id="form-query" class="page card hidden">
                <h2>استعلام درخواست</h2>
                <div class="form-group">
                    <label for="query-nick">نام گیم:</label>
                    <input type="text" id="query-nick" required>
                </div>
                <div class="form-group">
                    <label for="query-referral">رفرال:</label>
                    <input type="text" id="query-referral" required>
                </div>
                <button id="btn-submit-query" class="btn">بررسی</button>
                <button id="btn-back-from-query" class="btn btn-secondary">بازگشت</button>
            </div>
            
            <!-- نتیجه استعلام -->
            <div id="query-result" class="page card hidden">
                <div id="result-content">
                    <!-- نتیجه اینجا نمایش داده می‌شود -->
                </div>
                <div id="appeal-section" class="hidden">
                    <div class="form-group">
                        <label for="appeal-message">متن اعتراض:</label>
                        <textarea id="appeal-message" required></textarea>
                    </div>
                    <button id="btn-submit-appeal" class="btn">ارسال اعتراض</button>
                </div>
                <button id="btn-back-from-result" class="btn btn-secondary">بازگشت</button>
            </div>
            
            <!-- صفحه وضعیت تایید شده -->
            <div id="approved-info" class="page card hidden">
                <div id="approved-content">
                    <!-- اطلاعات تایید اینجا نمایش داده می‌شود -->
                </div>
                <button id="btn-ready" class="btn">آماده‌ام</button>
                <button id="btn-back-from-approved" class="btn btn-secondary">بازگشت</button>
            </div>
            
            <!-- صفحه نکات مهم -->
            <div id="important-notes" class="page card hidden">
                <h2>نکات مهم</h2>
                <div>
                    <p>1- اگر شما جزء افراد اسپشیال (ویژه) هستید پیوی مسئول تست که رفتید شرایط رو براتون توضیح میده و در صورتی که تایید کردید یه تایم مشخص میکنه که توی اون تایم میای سرور و تیم اسپیک و ازتون تست میگیره</p>
                    <p>2- در صورتی که در زمان کوتاهی بر فرض مثال کمتر از یک ماه استعفا بدید بلک لیست استف بیشتری نسبت به حالت عادی دریافت میکنید و تا وقتی بلک لیست استف باشید نمی‌تونید ( لیدر - ساب لیدر - کریتور ) شوید + امکان پانیش نیز میباشد پس در صورتی که تایم ندارید یا بنا بر دلایلی طی روز ها یا ماه های آینده به مشکل خوردید و نتوانستید فعالیت کنید، همین الان میتوانید انصراف بدید بدون هیچ برخورد و پانیشمنتی! اما اگر عضو تیم ساپورتری بشید و در تایم کوتاهی (کمتر از یک ماه) به هر دلیلی از تیم ساپورتری خارج بشید برخورد در پی دارد!!!</p>
                    <p>3- درصورتی که تست رو قبول شدید نمونه احراز پیوی شما ارسال میشه و مطابق اون پیوی سرور منیجر @to_031 احراز هویت میکنید در ضمن ( احراز هویت های شما رو فقط و فقط سرور منیجر دارن و هیچکس دیگه ای احراز شما رو نمی‌بینه )</p>
                    <p>4- تست از تمامی قوانین سرور + سی ام دی های سرور هست (بجز نظام وظیفه)</p>
                    <p>مسئول تست شما: <span id="tester-name"></span></p>
                </div>
                <button id="btn-back-from-notes" class="btn btn-secondary">بازگشت</button>
            </div>
        </div>
    </div>

    <script>
        // متغیرهای جهانی
        let tg = null;
        let userData = null;
        let isAdmin = false;
        const API_BASE = 'https://rsm-helper.hupadr.workers.dev';
        
        // صفحات
        const pages = {
            loading: document.getElementById('loading'),
            browserError: document.getElementById('browser-error'),
            adminPanel: document.getElementById('admin-panel'),
            userPanel: document.getElementById('user-panel'),
            formAddAdmin: document.getElementById('form-add-admin'),
            formDecideRequest: document.getElementById('form-decide-request'),
            formQuery: document.getElementById('form-query'),
            queryResult: document.getElementById('query-result'),
            approvedInfo: document.getElementById('approved-info'),
            importantNotes: document.getElementById('important-notes')
        };
        
        // نمایش صفحه مورد نظر و مخفی کردن بقیه
        function showPage(page) {
            Object.values(pages).forEach(p => {
                if (p && p.classList) {
                    p.classList.add('hidden');
                    p.classList.remove('active');
                }
            });
            
            if (page && page.classList) {
                page.classList.remove('hidden');
                page.classList.add('active');
            }
        }
        
        // بررسی اینکه آیا در محیط تلگرام هستیم یا نه
        function isTelegramWebApp() {
            return window.Telegram && window.Telegram.WebApp;
        }
        
        // بررسی initData و دریافت اطلاعات کاربر
        async function verifyInitData() {
            try {
                const initData = tg.initData;
                const response = await fetch(`${API_BASE}/api/verify-init`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ initData })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    userData = data.user;
                    isAdmin = data.is_admin;
                    
                    if (isAdmin) {
                        document.getElementById('admin-info').innerHTML = `
                            <h3>خوش آمدید ${userData.nick}</h3>
                            <p>رنک شما: ${userData.rank}</p>
                            <p>رفرال شما: ${userData.referral}</p>
                        `;
                        showPage(pages.adminPanel);
                    } else {
                        showPage(pages.userPanel);
                    }
                } else {
                    showError('خطا در احراز هویت');
                }
            } catch (error) {
                showError('خطا در ارتباط با سرور');
            }
        }
        
        // نمایش خطا
        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error';
            errorDiv.textContent = message;
            document.querySelector('.container').prepend(errorDiv);
            
            setTimeout(() => {
                errorDiv.remove();
            }, 5000);
        }
        
        // نمایش موفقیت
        function showSuccess(message) {
            const successDiv = document.createElement('div');
            successDiv.className = 'success';
            successDiv.textContent = message;
            document.querySelector('.container').prepend(successDiv);
            
            setTimeout(() => {
                successDiv.remove();
            }, 5000);
        }
        
        // مدیریت رویدادها
        function setupEventListeners() {
            // دکمه‌های پنل ادمین
            document.getElementById('btn-add-admin').addEventListener('click', () => {
                showPage(pages.formAddAdmin);
            });
            
            document.getElementById('btn-decide-request').addEventListener('click', () => {
                loadAdminsForTester();
                showPage(pages.formDecideRequest);
            });
            
            document.getElementById('btn-back-from-add-admin').addEventListener('click', () => {
                showPage(pages.adminPanel);
            });
            
            document.getElementById('btn-back-from-decide').addEventListener('click', () => {
                showPage(pages.adminPanel);
            });
            
            // تغییر وضعیت در فرم تصمیم‌گیری
            document.getElementById('request-status').addEventListener('change', (e) => {
                const status = e.target.value;
                document.getElementById('reason-field').classList.toggle('hidden', status !== 'rejected');
                document.getElementById('tester-field').classList.toggle('hidden', status !== 'approved');
            });
            
            // ثبت ادمین جدید
            document.getElementById('btn-submit-admin').addEventListener('click', async () => {
                const nick = document.getElementById('admin-nick').value;
                const referral = document.getElementById('admin-referral').value;
                const telegramId = document.getElementById('admin-telegram-id').value;
                const rank = document.getElementById('admin-rank').value;
                
                if (!nick || !referral || !telegramId || !rank) {
                    showError('لطفا تمام فیلدها را پر کنید');
                    return;
                }
                
                try {
                    const response = await fetch(`${API_BASE}/api/add-admin`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            initData: tg.initData,
                            nick,
                            referral,
                            telegram_id: telegramId,
                            rank
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        showSuccess('ادمین با موفقیت اضافه شد');
                        document.getElementById('admin-nick').value = '';
                        document.getElementById('admin-referral').value = '';
                        document.getElementById('admin-telegram-id').value = '';
                        document.getElementById('admin-rank').value = '';
                        showPage(pages.adminPanel);
                    } else {
                        showError(data.message || 'خطا در افزودن ادمین');
                    }
                } catch (error) {
                    showError('خطا در ارتباط با سرور');
                }
            });
            
            // ثبت تصمیم
            document.getElementById('btn-submit-decision').addEventListener('click', async () => {
                const nick = document.getElementById('request-nick').value;
                const referral = document.getElementById('request-referral').value;
                const telegramId = document.getElementById('request-telegram-id').value;
                const status = document.getElementById('request-status').value;
                const reason = document.getElementById('request-reason').value;
                const tester = document.getElementById('request-tester').value;
                
                if (!nick || !referral || !telegramId || !status) {
                    showError('لطفا تمام فیلدهای ضروری را پر کنید');
                    return;
                }
                
                if (status === 'rejected' && !reason) {
                    showError('لطفا دلیل رد را وارد کنید');
                    return;
                }
                
                if (status === 'approved' && !tester) {
                    showError('لطفا مسئول تست را انتخاب کنید');
                    return;
                }
                
                try {
                    const response = await fetch(`${API_BASE}/api/decide`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            initData: tg.initData,
                            nick,
                            referral,
                            telegram_id: telegramId,
                            status,
                            reason: status === 'rejected' ? reason : null,
                            tester: status === 'approved' ? tester : null
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        showSuccess('تصمیم با موفقیت ثبت شد');
                        document.getElementById('request-nick').value = '';
                        document.getElementById('request-referral').value = '';
                        document.getElementById('request-telegram-id').value = '';
                        document.getElementById('request-status').value = '';
                        document.getElementById('request-reason').value = '';
                        document.getElementById('request-tester').value = '';
                        document.getElementById('reason-field').classList.add('hidden');
                        document.getElementById('tester-field').classList.add('hidden');
                        showPage(pages.adminPanel);
                    } else {
                        showError(data.message || 'خطا در ثبت تصمیم');
                    }
                } catch (error) {
                    showError('خطا در ارتباط با سرور');
                }
            });
            
            // دکمه‌های پنل کاربری
            document.getElementById('btn-query-request').addEventListener('click', () => {
                showPage(pages.formQuery);
            });
            
            document.getElementById('btn-back-from-query').addEventListener('click', () => {
                showPage(pages.userPanel);
            });
            
            document.getElementById('btn-back-from-result').addEventListener('click', () => {
                showPage(pages.userPanel);
            });
            
            document.getElementById('btn-back-from-approved').addEventListener('click', () => {
                showPage(pages.userPanel);
            });
            
            document.getElementById('btn-back-from-notes').addEventListener('click', () => {
                showPage(pages.approvedInfo);
            });
            
            // ارسال استعلام
            document.getElementById('btn-submit-query').addEventListener('click', async () => {
                const nick = document.getElementById('query-nick').value;
                const referral = document.getElementById('query-referral').value;
                
                if (!nick || !referral) {
                    showError('لطفا تمام فیلدها را پر کنید');
                    return;
                }
                
                try {
                    const response = await fetch(`${API_BASE}/api/query`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            initData: tg.initData,
                            nick,
                            referral
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        const resultContent = document.getElementById('result-content');
                        const appealSection = document.getElementById('appeal-section');
                        
                        if (data.status === 'not_found') {
                            resultContent.innerHTML = '<p>اطلاعات شما در دیتابیس یافت نشد.</p>';
                            appealSection.classList.add('hidden');
                        } else if (data.status === 'rejected') {
                            resultContent.innerHTML = `
                                <p>کاربر گرامی ${data.nick} با ${data.referral} متأسفانه رد شده‌اید.</p>
                                <p>دلیل: ${data.reason}</p>
                                <p>نگران نباشید؛ می‌توانید اعتراض ثبت کنید.</p>
                            `;
                            appealSection.classList.remove('hidden');
                        } else if (data.status === 'approved') {
                            document.getElementById('approved-content').innerHTML = `
                                <h3>سلام و درود بر تو ${data.nick}</h3>
                                <p>خوشبختانه درخواست عضویت شما در تیم ساپورتری تایید شده است</p>
                                <p>مسئول تست شما: ${data.tester}</p>
                            `;
                            document.getElementById('tester-name').textContent = data.tester;
                            showPage(pages.approvedInfo);
                            return;
                        }
                        
                        showPage(pages.queryResult);
                    } else {
                        showError(data.message || 'خطا در استعلام');
                    }
                } catch (error) {
                    showError('خطا در ارتباط با سرور');
                }
            });
            
            // ارسال اعتراض
            document.getElementById('btn-submit-appeal').addEventListener('click', async () => {
                const message = document.getElementById('appeal-message').value;
                const nick = document.getElementById('query-nick').value;
                const referral = document.getElementById('query-referral').value;
                
                if (!message) {
                    showError('لطفا متن اعتراض را وارد کنید');
                    return;
                }
                
                try {
                    const response = await fetch(`${API_BASE}/api/appeal`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            initData: tg.initData,
                            nick,
                            referral,
                            message
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        showSuccess('اعتراض شما با موفقیت ثبت شد');
                        document.getElementById('appeal-message').value = '';
                        showPage(pages.userPanel);
                    } else {
                        showError(data.message || 'خطا در ثبت اعتراض');
                    }
                } catch (error) {
                    showError('خطا در ارتباط با سرور');
                }
            });
            
            // دکمه آماده‌ام
            document.getElementById('btn-ready').addEventListener('click', () => {
                showPage(pages.importantNotes);
            });
        }
        
        // بارگذاری لیست ادمین‌ها برای انتخاب مسئول تست
        async function loadAdminsForTester() {
            try {
                const response = await fetch(`${API_BASE}/api/list-admins`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    const testerSelect = document.getElementById('request-tester');
                    testerSelect.innerHTML = '<option value="">انتخاب کنید</option>';
                    
                    data.admins.forEach(admin => {
                        const option = document.createElement('option');
                        option.value = admin.nick;
                        option.textContent = `تست(${admin.nick}) - ${admin.rank}`;
                        testerSelect.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('خطا در بارگذاری لیست ادمین‌ها');
            }
        }
        
        // مقداردهی اولیه برنامه
        function initApp() {
            if (!isTelegramWebApp()) {
                showPage(pages.browserError);
                return;
            }
            
            tg = window.Telegram.WebApp;
            tg.expand();
            
            setupEventListeners();
            verifyInitData();
        }
        
        // شروع برنامه زمانی که DOM بارگذاری شد
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
