<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RSM Helper</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #3498db;
            --success: #2ecc71;
            --danger: #e74c3c;
            --warning: #f39c12;
            --dark: #2c3e50;
            --light: #ecf0f1;
            --gray: #95a5a6;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Vazirmatn', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 0;
            padding: 0;
            color: #333;
            min-height: 100vh;
        }
        
        .container {
            max-width: 100%;
            margin: 0 auto;
            padding: 0;
            background-color: #fff;
            min-height: 100vh;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }
        
        .header {
            text-align: center;
            padding: 20px 15px;
            background: linear-gradient(135deg, var(--primary) 0%, #2980b9 100%);
            color: white;
            border-radius: 0 0 20px 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            color: white;
            margin: 0;
            font-size: 1.5rem;
        }
        
        .welcome-message {
            text-align: center;
            margin-bottom: 30px;
            padding: 0 15px;
        }
        
        .welcome-message p {
            margin-bottom: 15px;
            line-height: 1.6;
        }
        
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 12px 20px;
            background-color: var(--primary);
            color: white;
            text-decoration: none;
            border-radius: 10px;
            margin: 8px 5px;
            cursor: pointer;
            border: none;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 8px rgba(0,0,0,0.15);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .btn i {
            margin-left: 8px;
        }
        
        .btn-primary {
            background-color: var(--primary);
        }
        
        .btn-success {
            background-color: var(--success);
        }
        
        .btn-danger {
            background-color: var(--danger);
        }
        
        .btn-warning {
            background-color: var(--warning);
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: var(--dark);
        }
        
        input, select, textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #ddd;
            border-radius: 10px;
            box-sizing: border-box;
            font-family: 'Vazirmatn', sans-serif;
            transition: border-color 0.3s;
        }
        
        input:focus, select:focus, textarea:focus {
            border-color: var(--primary);
            outline: none;
        }
        
        .card {
            background-color: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            border: 1px solid #eee;
        }
        
        .admin-card {
            background: linear-gradient(135deg, #f6d365 0%, #fda085 100%);
            color: white;
        }
        
        .hidden {
            display: none;
        }
        
        .result-message {
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 25px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        
        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .warning {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        
        .info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .section {
            padding: 20px 15px;
        }
        
        .section-title {
            font-size: 1.3rem;
            margin-bottom: 20px;
            color: var(--dark);
            text-align: center;
            padding-bottom: 10px;
            border-bottom: 2px solid #eee;
        }
        
        .back-btn {
            display: inline-flex;
            align-items: center;
            margin-bottom: 15px;
            color: var(--primary);
            cursor: pointer;
            font-weight: 500;
        }
        
        .back-btn i {
            margin-right: 5px;
        }
        
        .request-item {
            border-left: 4px solid var(--primary);
            padding-left: 15px;
            margin-bottom: 20px;
        }
        
        .admin-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .admin-info-item {
            flex: 1;
            min-width: 150px;
            text-align: center;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 10px;
            margin: 5px;
        }
        
        .admin-info-item h3 {
            font-size: 0.9rem;
            color: var(--gray);
            margin-bottom: 5px;
        }
        
        .admin-info-item p {
            font-size: 1.1rem;
            font-weight: bold;
            color: var(--dark);
        }
        
        .loader {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
        }
        
        .loader-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @media (min-width: 768px) {
            .container {
                max-width: 500px;
                margin: 20px auto;
                min-height: auto;
                border-radius: 20px;
                overflow: hidden;
            }
            
            .header {
                border-radius: 0;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="loading" class="section">
            <div class="loader">
                <div class="loader-spinner"></div>
            </div>
            <p style="text-align: center; margin-top: 20px;">در حال بارگذاری...</p>
        </div>

        <!-- صفحه اصلی ادمین -->
        <div id="admin-panel" class="hidden">
            <div class="header">
                <h1>پنل مدیریت RSM Helper</h1>
            </div>
            
            <div class="section">
                <div class="welcome-message">
                    <p>ادمین گرامی <span id="admin-name" style="font-weight: bold;"></span>، خوش آمدید</p>
                    
                    <div class="card admin-card">
                        <div class="admin-info">
                            <div class="admin-info-item">
                                <h3>رنک شما</h3>
                                <p id="admin-rank"></p>
                            </div>
                            <div class="admin-info-item">
                                <h3>رفرال شما</h3>
                                <p id="admin-referral"></p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div style="text-align: center; margin-top: 30px;">
                    <button id="add-admin-btn" class="btn btn-primary"><i class="fas fa-user-plus"></i> افزودن ادمین</button>
                    <button id="review-requests-btn" class="btn btn-success"><i class="fas fa-check-circle"></i> تایید/رد درخواست</button>
                </div>
            </div>

            <!-- بخش افزودن ادمین -->
            <div id="add-admin-section" class="hidden">
                <div class="header">
                    <h1>افزودن ادمین جدید</h1>
                </div>
                
                <div class="section">
                    <div class="back-btn" id="cancel-add-admin">
                        <i class="fas fa-arrow-right"></i> بازگشت
                    </div>
                    
                    <form id="add-admin-form">
                        <div class="form-group">
                            <label for="new-admin-name"><i class="fas fa-user"></i> نام گیم:</label>
                            <input type="text" id="new-admin-name" required placeholder="نام گیم ادمین جدید">
                        </div>
                        <div class="form-group">
                            <label for="new-admin-referral"><i class="fas fa-id-card"></i> رفرال:</label>
                            <input type="text" id="new-admin-referral" required placeholder="رفرال ادمین جدید">
                        </div>
                        <div class="form-group">
                            <label for="new-admin-telegram-id"><i class="fab fa-telegram"></i> ایدی عددی تلگرام:</label>
                            <input type="number" id="new-admin-telegram-id" required placeholder="ایدی عددی تلگرام">
                        </div>
                        <div class="form-group">
                            <label for="new-admin-rank"><i class="fas fa-star"></i> رنک:</label>
                            <select id="new-admin-rank" required>
                                <!-- گزینه‌ها به صورت پویا پر می‌شوند -->
                            </select>
                        </div>
                        <div style="text-align: center; margin-top: 30px;">
                            <button type="submit" class="btn btn-success"><i class="fas fa-save"></i> ثبت ادمین جدید</button>
                            <button type="button" id="cancel-add-admin-btn" class="btn btn-danger"><i class="fas fa-times"></i> لغو</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- بخش تایید/رد درخواست -->
            <div id="review-requests-section" class="hidden">
                <div class="header">
                    <h1>تایید/رد درخواست‌ها</h1>
                </div>
                
                <div class="section">
                    <div class="back-btn" id="back-to-admin-panel">
                        <i class="fas fa-arrow-right"></i> بازگشت
                    </div>
                    
                    <div id="requests-list">
                        <!-- لیست درخواست‌ها به صورت پویا پر می‌شود -->
                    </div>
                </div>
            </div>
        </div>

        <!-- صفحه اصلی کاربر -->
        <div id="user-panel" class="hidden">
            <div class="header">
                <h1>RSM Helper</h1>
            </div>
            
            <div class="section">
                <div class="welcome-message">
                    <p>کاربر گرامی، خوش آمدید</p>
                    <p>برای استعلام درخواست عضویت شما در تیم ساپورتری از دکمه زیر استفاده کنید:</p>
                    
                    <div style="text-align: center; margin-top: 30px;">
                        <button id="check-request-btn" class="btn btn-primary"><i class="fas fa-search"></i> استعلام درخواست</button>
                    </div>
                </div>
            </div>

            <!-- صفحه استعلام درخواست -->
            <div id="check-request-section" class="hidden">
                <div class="header">
                    <h1>استعلام درخواست</h1>
                </div>
                
                <div class="section">
                    <div class="back-btn" id="back-to-user-panel">
                        <i class="fas fa-arrow-right"></i> بازگشت
                    </div>
                    
                    <form id="check-request-form">
                        <div class="form-group">
                            <label for="user-name"><i class="fas fa-user"></i> نام گیم شما:</label>
                            <input type="text" id="user-name" required placeholder="نام گیم خود را وارد کنید">
                        </div>
                        <div class="form-group">
                            <label for="user-referral"><i class="fas fa-id-card"></i> رفرال شما:</label>
                            <input type="text" id="user-referral" required placeholder="رفرال خود را وارد کنید">
                        </div>
                        <div style="text-align: center; margin-top: 30px;">
                            <button type="submit" class="btn btn-primary"><i class="fas fa-check"></i> بررسی</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- صفحه نتایج استعلام -->
            <div id="request-result" class="hidden">
                <div class="header">
                    <h1>نتیجه استعلام</h1>
                </div>
                
                <div class="section">
                    <div class="back-btn" id="back-to-check-request">
                        <i class="fas fa-arrow-right"></i> بازگشت
                    </div>
                    
                    <div id="result-content">
                        <!-- نتایج به صورت پویا نمایش داده می‌شوند -->
                    </div>
                </div>
            </div>

            <!-- صفحه اعتراض -->
            <div id="complaint-section" class="hidden">
                <div class="header">
                    <h1>اعتراض به نتیجه</h1>
                </div>
                
                <div class="section">
                    <div class="back-btn" id="back-to-request-result">
                        <i class="fas fa-arrow-right"></i> بازگشت
                    </div>
                    
                    <form id="complaint-form">
                        <div class="form-group">
                            <label for="complaint-message"><i class="fas fa-envelope"></i> پیام اعتراض:</label>
                            <textarea id="complaint-message" rows="5" required placeholder="متن اعتراض خود را بنویسید..."></textarea>
                        </div>
                        <div style="text-align: center; margin-top: 30px;">
                            <button type="submit" class="btn btn-primary"><i class="fas fa-paper-plane"></i> ارسال اعتراض</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- صفحه خطا برای دسترسی خارج از تلگرام -->
        <div id="error-panel" class="hidden">
            <div class="header">
                <h1>خطا در دسترسی</h1>
            </div>
            
            <div class="section">
                <div class="welcome-message">
                    <div class="card error">
                        <i class="fas fa-exclamation-circle" style="font-size: 3rem; margin-bottom: 20px;"></i>
                        <p>این سرویس فقط از طریق تلگرام در دسترس است.</p>
                        <p>لطفاً از طریق ربات تلگرامی RSM Helper به این سرویس دسترسی پیدا کنید.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // متغیرهای سراسری
        let tg = window.Telegram?.WebApp;
        let userTelegramId = null;
        let isAdmin = false;
        let adminData = null;
        let userData = null;

        // تابع بررسی اینکه آیا در محیط تلگرام هستیم یا نه
        function isTelegramEnvironment() {
            return typeof tg !== 'undefined' && tg?.initDataUnsafe?.user;
        }

        // تابع دریافت اطلاعات کاربر از تلگرام
        function getTelegramUserData() {
            if (isTelegramEnvironment()) {
                const user = tg.initDataUnsafe.user;
                userTelegramId = user.id;
                return {
                    id: user.id,
                    username: user.username,
                    first_name: user.first_name,
                    last_name: user.last_name
                };
            }
            return null;
        }

        // تابع بررسی اینکه آیا کاربر ادمین است
        async function checkIfAdmin(userId) {
            try {
                const response = await fetch('https://rsm-helper.hupadr.workers.dev/get-admin', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ telegram_id: userId })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.success && data.admin) {
                        adminData = data.admin;
                        return true;
                    }
                }
                return false;
            } catch (error) {
                console.error('Error checking admin status:', error);
                return false;
            }
        }

        // تابع ارسال درخواست به Worker
        async function callWorker(endpoint, data) {
            try {
                const response = await fetch(`https://rsm-helper.hupadr.workers.dev${endpoint}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                
                return await response.json();
            } catch (error) {
                console.error(`Error calling ${endpoint}:`, error);
                return { success: false, error: error.message };
            }
        }

        // تابع نمایش صفحه مناسب بر اساس وضعیت کاربر
        function showAppropriatePanel() {
            document.getElementById('loading').classList.add('hidden');
            
            if (!isTelegramEnvironment()) {
                document.getElementById('error-panel').classList.remove('hidden');
                return;
            }
            
            if (isAdmin) {
                document.getElementById('admin-panel').classList.remove('hidden');
                document.getElementById('admin-name').textContent = adminData.name;
                document.getElementById('admin-rank').textContent = adminData.rank;
                document.getElementById('admin-referral').textContent = adminData.referral;
                
                // تنظیم گزینه‌های رنک بر اساس رنک ادمین فعلی
                setupRankOptions();
            } else {
                document.getElementById('user-panel').classList.remove('hidden');
            }
        }

        // تابع تنظیم گزینه‌های رنک برای افزودن ادمین جدید
        function setupRankOptions() {
            const rankSelect = document.getElementById('new-admin-rank');
            rankSelect.innerHTML = '';
            
            const ranks = {
                'Developer': ['Support Manager', 'Support Advisor', 'Support Director', 'Support Warden'],
                'Support Manager': ['Support Advisor', 'Support Director', 'Support Warden'],
                'Support Advisor': ['Support Director', 'Support Warden'],
                'Support Director': ['Support Warden']
            };
            
            const currentRank = adminData.rank;
            
            if (ranks[currentRank]) {
                ranks[currentRank].forEach(rank => {
                    const option = document.createElement('option');
                    option.value = rank;
                    option.textContent = rank;
                    rankSelect.appendChild(option);
                });
            }
            
            // اگر ادمین نمیتواند ادمین جدید اضافه کند، دکمه افزودن ادمین را مخفی کن
            if (currentRank === 'Support Warden' || !ranks[currentRank]) {
                document.getElementById('add-admin-btn').style.display = 'none';
            }
        }

        // تابع مدیریت رویدادها
        function setupEventListeners() {
            // مدیریت رویدادهای ادمین
            document.getElementById('add-admin-btn').addEventListener('click', () => {
                document.getElementById('admin-panel').classList.add('hidden');
                document.getElementById('add-admin-section').classList.remove('hidden');
            });
            
            document.getElementById('review-requests-btn').addEventListener('click', () => {
                document.getElementById('admin-panel').classList.add('hidden');
                document.getElementById('review-requests-section').classList.remove('hidden');
                loadRequestsList();
            });
            
            document.getElementById('cancel-add-admin').addEventListener('click', () => {
                document.getElementById('add-admin-section').classList.add('hidden');
                document.getElementById('admin-panel').classList.remove('hidden');
            });
            
            document.getElementById('cancel-add-admin-btn').addEventListener('click', () => {
                document.getElementById('add-admin-section').classList.add('hidden');
                document.getElementById('admin-panel').classList.remove('hidden');
            });
            
            document.getElementById('back-to-admin-panel').addEventListener('click', () => {
                document.getElementById('review-requests-section').classList.add('hidden');
                document.getElementById('admin-panel').classList.remove('hidden');
            });
            
            // مدیریت فرم افزودن ادمین
            document.getElementById('add-admin-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const name = document.getElementById('new-admin-name').value;
                const referral = document.getElementById('new-admin-referral').value;
                const telegramId = document.getElementById('new-admin-telegram-id').value;
                const rank = document.getElementById('new-admin-rank').value;
                
                const result = await callWorker('/add-admin', {
                    name, referral, telegram_id: telegramId, rank
                });
                
                if (result.success) {
                    alert('ادمین جدید با موفقیت افزوده شد.');
                    document.getElementById('add-admin-form').reset();
                    document.getElementById('add-admin-section').classList.add('hidden');
                    document.getElementById('admin-panel').classList.remove('hidden');
                } else {
                    alert('خطا در افزودن ادمین: ' + (result.error || 'خطای ناشناخته'));
                }
            });
            
            // مدیریت رویدادهای کاربر
            document.getElementById('check-request-btn').addEventListener('click', () => {
                document.getElementById('user-panel').classList.add('hidden');
                document.getElementById('check-request-section').classList.remove('hidden');
            });
            
            document.getElementById('back-to-user-panel').addEventListener('click', () => {
                document.getElementById('check-request-section').classList.add('hidden');
                document.getElementById('user-panel').classList.remove('hidden');
            });
            
            document.getElementById('back-to-check-request').addEventListener('click', () => {
                document.getElementById('request-result').classList.add('hidden');
                document.getElementById('check-request-section').classList.remove('hidden');
            });
            
            document.getElementById('back-to-request-result').addEventListener('click', () => {
                document.getElementById('complaint-section').classList.add('hidden');
                document.getElementById('request-result').classList.remove('hidden');
            });
            
            // مدیریت فرم استعلام درخواست
            document.getElementById('check-request-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const name = document.getElementById('user-name').value;
                const referral = document.getElementById('user-referral').value;
                
                const result = await callWorker('/check-request', {
                    telegram_id: userTelegramId,
                    name,
                    referral
                });
                
                document.getElementById('check-request-section').classList.add('hidden');
                document.getElementById('request-result').classList.remove('hidden');
                
                displayRequestResult(result, name, referral);
            });
            
            // مدیریت فرم اعتراض
            document.getElementById('complaint-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const message = document.getElementById('complaint-message').value;
                
                const result = await callWorker('/submit-complaint', {
                    telegram_id: userTelegramId,
                    message
                });
                
                if (result.success) {
                    alert('اعتراض شما با موفقیت ارسال شد.');
                    document.getElementById('complaint-form').reset();
                    document.getElementById('complaint-section').classList.add('hidden');
                    document.getElementById('user-panel').classList.remove('hidden');
                } else {
                    alert('خطا در ارسال اعتراض: ' + (result.error || 'خطای ناشناخته'));
                }
            });
        }

        // تابع نمایش نتیجه استعلام
        function displayRequestResult(result, name, referral) {
            const resultContent = document.getElementById('result-content');
            resultContent.innerHTML = '';
            
            if (result.success && result.request) {
                const request = result.request;
                
                if (request.status === 'rejected') {
                    // درخواست رد شده
                    const rejectedDiv = document.createElement('div');
                    rejectedDiv.className = 'result-message error';
                    rejectedDiv.innerHTML = `
                        <h3><i class="fas fa-times-circle"></i> متأسفانه درخواست شما رد شده است</h3>
                        <p>کاربر گرامی <strong>${name}</strong> با رفرال <strong>${referral}</strong></p>
                        <p>طی بررسی‌هایی که انجام دادیم متأسفانه شما رد شدید.</p>
                        <p><strong>دلیل رد:</strong> ${request.rejection_reason || 'دلیل مشخص نشده'}</p>
                        <p>نگران نباشید، هنوز فرصت اعتراض دارید.</p>
                        <button id="complaint-btn" class="btn btn-warning" style="margin-top: 15px;">
                            <i class="fas fa-exclamation-triangle"></i> اعتراض به نتیجه
                        </button>
                    `;
                    resultContent.appendChild(rejectedDiv);
                    
                    document.getElementById('complaint-btn').addEventListener('click', () => {
                        document.getElementById('request-result').classList.add('hidden');
                        document.getElementById('complaint-section').classList.remove('hidden');
                    });
                    
                } else if (request.status === 'approved') {
                    // درخواست تایید شده
                    const approvedDiv = document.createElement('div');
                    approvedDiv.className = 'result-message success';
                    approvedDiv.innerHTML = `
                        <h3><i class="fas fa-check-circle"></i> درخواست شما تایید شده است</h3>
                        <p>سلام و درود بر تو <strong>${name}</strong></p>
                        <p>خوشبختانه درخواست عضویت شما در تیم ساپورتری تایید شده است.</p>
                        <p><strong>مسئول تست شما:</strong> ${request.tester || 'نامشخص'}</p>
                        
                        <div class="card info" style="margin-top: 20px;">
                            <h4><i class="fas fa-info-circle"></i> نکات مهم:</h4>
                            <p>1. اگر شما جزء افراد اسپشیال (ویژه) هستید، پیوی مسئول تست شرایط رو براتون توضیح میده.</p>
                            <p>2. در صورتی که در زمان کوتاهی (کمتر از یک ماه) استعفا بدید، بلک لیست استف بیشتری دریافت میکنید.</p>
                            <p>3. تست از تمامی قوانین سرور + سی ام دی های سرور هست (بجز نظام وظیفه).</p>
                            <p>4. احراز هویت های شما رو فقط و فقط سرور منیجر دارن و هیچکس دیگه‌ای احراز شما رو نمی‌بینه.</p>
                        </div>
                        
                        <button id="ready-btn" class="btn btn-success" style="margin-top: 15px;">
                            <i class="fas fa-thumbs-up"></i> آماده‌ام
                        </button>
                    `;
                    resultContent.appendChild(approvedDiv);
                    
                    document.getElementById('ready-btn').addEventListener('click', () => {
                        alert('با تشکر! اطلاعات لازم در اختیار شما قرار گرفت.');
                        document.getElementById('request-result').classList.add('hidden');
                        document.getElementById('user-panel').classList.remove('hidden');
                    });
                    
                } else {
                    // وضعیت نامشخص یا در حال بررسی
                    const pendingDiv = document.createElement('div');
                    pendingDiv.className = 'result-message warning';
                    pendingDiv.innerHTML = `
                        <h3><i class="fas fa-clock"></i> درخواست شما در حال بررسی است</h3>
                        <p>کاربر گرامی <strong>${name}</strong> با رفرال <strong>${referral}</strong></p>
                        <p>درخواست شما هنوز در حال بررسی می‌باشد. لطفاً稍后 مجدداً بررسی کنید.</p>
                    `;
                    resultContent.appendChild(pendingDiv);
                }
            } else {
                // خطا یا عدم یافتن درخواست
                const errorDiv = document.createElement('div');
                errorDiv.className = 'result-message error';
                errorDiv.innerHTML = `
                    <h3><i class="fas fa-exclamation-triangle"></i> خطا در یافتن اطلاعات</h3>
                    <p>متأسفانه اطلاعاتی برای نام گیم <strong>${name}</strong> و رفرال <strong>${referral}</strong> یافت نشد.</p>
                    <p>لطفاً از صحت اطلاعات وارد شده اطمینان حاصل کنید.</p>
                `;
                resultContent.appendChild(errorDiv);
            }
        }

        // تابع بارگذاری لیست درخواست‌ها برای ادمین
        async function loadRequestsList() {
            const requestsList = document.getElementById('requests-list');
            requestsList.innerHTML = '<div class="loader"><div class="loader-spinner"></div></div>';
            
            const result = await callWorker('/get-requests', {});
            
            requestsList.innerHTML = '';
            
            if (result.success && result.requests && result.requests.length > 0) {
                result.requests.forEach(request => {
                    const requestItem = document.createElement('div');
                    requestItem.className = 'card request-item';
                    requestItem.innerHTML = `
                        <h3>${request.name} (${request.referral})</h3>
                        <p>ایدی: ${request.telegram_id}</p>
                        <p>وضعیت: ${request.status || 'در حال بررسی'}</p>
                        
                        <div style="margin-top: 15px;">
                            <button class="btn btn-success approve-btn" data-id="${request.id}" style="margin-left: 10px;">
                                <i class="fas fa-check"></i> تایید
                            </button>
                            <button class="btn btn-danger reject-btn" data-id="${request.id}">
                                <i class="fas fa-times"></i> رد
                            </button>
                        </div>
                        
                        <div id="reject-form-${request.id}" class="hidden" style="margin-top: 15px;">
                            <div class="form-group">
                                <label for="reject-reason-${request.id}">دلیل رد:</label>
                                <input type="text" id="reject-reason-${request.id}" placeholder="دلیل رد درخواست">
                            </div>
                            <button class="btn btn-danger confirm-reject-btn" data-id="${request.id}">
                                <i class="fas fa-check"></i> تایید رد
                            </button>
                        </div>
                        
                        <div id="approve-form-${request.id}" class="hidden" style="margin-top: 15px;">
                            <div class="form-group">
                                <label for="tester-${request.id}">مسئول تست:</label>
                                <select id="tester-${request.id}">
                                    <!-- گزینه‌ها به صورت پویا پر می‌شوند -->
                                </select>
                            </div>
                            <button class="btn btn-success confirm-approve-btn" data-id="${request.id}">
                                <i class="fas fa-check"></i> تایید
                            </button>
                        </div>
                    `;
                    requestsList.appendChild(requestItem);
                    
                    // رویدادهای دکمه‌ها
                    requestItem.querySelector('.approve-btn').addEventListener('click', () => {
                        const approveForm = document.getElementById(`approve-form-${request.id}`);
                        const rejectForm = document.getElementById(`reject-form-${request.id}`);
                        
                        if (approveForm.classList.contains('hidden')) {
                            approveForm.classList.remove('hidden');
                            rejectForm.classList.add('hidden');
                        } else {
                            approveForm.classList.add('hidden');
                        }
                    });
                    
                    requestItem.querySelector('.reject-btn').addEventListener('click', () => {
                        const approveForm = document.getElementById(`approve-form-${request.id}`);
                        const rejectForm = document.getElementById(`reject-form-${request.id}`);
                        
                        if (rejectForm.classList.contains('hidden')) {
                            rejectForm.classList.remove('hidden');
                            approveForm.classList.add('hidden');
                        } else {
                            rejectForm.classList.add('hidden');
                        }
                    });
                    
                    requestItem.querySelector('.confirm-reject-btn').addEventListener('click', async () => {
                        const reason = document.getElementById(`reject-reason-${request.id}`).value;
                        
                        if (!reason) {
                            alert('لطفاً دلیل رد را وارد کنید.');
                            return;
                        }
                        
                        const result = await callWorker('/update-request', {
                            request_id: request.id,
                            status: 'rejected',
                            rejection_reason: reason
                        });
                        
                        if (result.success) {
                            alert('درخواست با موفقیت رد شد.');
                            loadRequestsList();
                        } else {
                            alert('خطا در رد درخواست: ' + (result.error || 'خطای ناشناخته'));
                        }
                    });
                    
                    requestItem.querySelector('.confirm-approve-btn').addEventListener('click', async () => {
                        const tester = document.getElementById(`tester-${request.id}`).value;
                        
                        if (!tester) {
                            alert('لطفاً مسئول تست را انتخاب کنید.');
                            return;
                        }
                        
                        const result = await callWorker('/update-request', {
                            request_id: request.id,
                            status: 'approved',
                            tester: tester
                        });
                        
                        if (result.success) {
                            alert('درخواست با موفقیت تایید شد.');
                            loadRequestsList();
                        } else {
                            alert('خطا در تایید درخواست: ' + (result.error || 'خطای ناشناخته'));
                        }
                    });
                });
            } else {
                requestsList.innerHTML = `
                    <div class="card info">
                        <p>هیچ درخواستی برای بررسی وجود ندارد.</p>
                    </div>
                `;
            }
        }

        // تابع مقداردهی اولیه برنامه
        async function initializeApp() {
            if (!isTelegramEnvironment()) {
                showAppropriatePanel();
                return;
            }
            
            const userData = getTelegramUserData();
            if (userData) {
                isAdmin = await checkIfAdmin(userData.id);
            }
            
            showAppropriatePanel();
            setupEventListeners();
            
            // گسترش وب‌اپ تلگرام به صفحه کامل
            if (tg) {
                tg.expand();
                tg.enableClosingConfirmation();
            }
        }

        // شروع برنامه پس از بارگذاری کامل صفحه
        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</body>
</html>
