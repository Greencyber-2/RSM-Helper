<!DOCTYPE html>
<html dir="rtl" lang="fa">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RSM Helper</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.6;
            padding: 0;
            margin: 0;
        }
        
        .container {
            max-width: 100%;
            padding: 20px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            padding: 15px 0;
            background-color: #0088cc;
            color: white;
            border-radius: 10px 10px 0 0;
            margin-bottom: 20px;
        }
        
        .card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        
        .btn {
            display: block;
            width: 100%;
            padding: 12px;
            background-color: #0088cc;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 0;
            text-align: center;
        }
        
        .btn:hover {
            background-color: #006da3;
        }
        
        .btn-secondary {
            background-color: #6c757d;
        }
        
        .btn-secondary:hover {
            background-color: #5a6268;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }
        
        .error {
            color: #dc3545;
            text-align: center;
            padding: 10px;
            background-color: #f8d7da;
            border-radius: 5px;
            margin-bottom: 15px;
        }
        
        .success {
            color: #155724;
            text-align: center;
            padding: 10px;
            background-color: #d4edda;
            border-radius: 5px;
            margin-bottom: 15px;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
        }
        
        .hidden {
            display: none;
        }
        
        .nav {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
        }
        
        .result-card {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin-top: 15px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- صفحه اصلی - انتخاب پنل -->
        <div id="main-page" class="hidden">
            <div class="header">
                <h1>RSM Helper</h1>
            </div>
            
            <div id="user-panel" class="hidden">
                <div class="card">
                    <h2>پنل کاربری</h2>
                    <p id="user-welcome">خوش آمدید!</p>
                    <button id="query-btn" class="btn">استعلام درخواست</button>
                </div>
            </div>
            
            <div id="admin-panel" class="hidden">
                <div class="card">
                    <h2>پنل مدیریت</h2>
                    <p id="admin-welcome">خوش آمدید!</p>
                    <button id="add-admin-btn" class="btn">افزودن ادمین</button>
                    <button id="decide-request-btn" class="btn">تایید/رد درخواست</button>
                </div>
            </div>
        </div>
        
        <!-- صفحه استعلام کاربر -->
        <div id="query-page" class="hidden">
            <div class="nav">
                <button id="back-from-query" class="btn btn-secondary">بازگشت</button>
            </div>
            
            <div class="card">
                <h2>استعلام درخواست</h2>
                
                <div class="form-group">
                    <label for="nick">نام گیم:</label>
                    <input type="text" id="nick" placeholder="نام گیم خود را وارد کنید">
                </div>
                
                <div class="form-group">
                    <label for="referral">رفرال:</label>
                    <input type="text" id="referral" placeholder="کد رفرال خود را وارد کنید">
                </div>
                
                <button id="check-request-btn" class="btn">بررسی</button>
                
                <div id="query-result" class="result-card hidden"></div>
            </div>
        </div>
        
        <!-- صفحه اعتراض کاربر -->
        <div id="appeal-page" class="hidden">
            <div class="nav">
                <button id="back-from-appeal" class="btn btn-secondary">بازگشت</button>
            </div>
            
            <div class="card">
                <h2>ثبت اعتراض</h2>
                <p>لطفاً دلیل اعتراض خود را به طور کامل شرح دهید:</p>
                
                <div class="form-group">
                    <textarea id="appeal-message" rows="5" placeholder="متن اعتراض..."></textarea>
                </div>
                
                <button id="submit-appeal-btn" class="btn">ارسال اعتراض</button>
            </div>
        </div>
        
        <!-- صفحه افزودن ادمین -->
        <div id="add-admin-page" class="hidden">
            <div class="nav">
                <button id="back-from-add-admin" class="btn btn-secondary">بازگشت</button>
            </div>
            
            <div class="card">
                <h2>افزودن ادمین جدید</h2>
                
                <div class="form-group">
                    <label for="admin-nick">نام گیم:</label>
                    <input type="text" id="admin-nick" placeholder="نام گیم ادمین">
                </div>
                
                <div class="form-group">
                    <label for="admin-referral">رفرال:</label>
                    <input type="text" id="admin-referral" placeholder="کد رفرال ادمین">
                </div>
                
                <div class="form-group">
                    <label for="admin-tid">آیدی عددی تلگرام:</label>
                    <input type="number" id="admin-tid" placeholder="آیدی عددی تلگرام">
                </div>
                
                <div class="form-group">
                    <label for="admin-rank">رنک:</label>
                    <select id="admin-rank">
                        <option value="">-- انتخاب رنک --</option>
                        <option value="Support Warden">Support Warden</option>
                        <option value="Support Director">Support Director</option>
                        <option value="Support Advisor">Support Advisor</option>
                        <option value="Support Manager">Support Manager</option>
                        <option value="Developer">Developer</option>
                    </select>
                </div>
                
                <button id="submit-admin-btn" class="btn">ثبت ادمین</button>
            </div>
        </div>
        
        <!-- صفحه تایید/رد درخواست -->
        <div id="decide-request-page" class="hidden">
            <div class="nav">
                <button id="back-from-decide" class="btn btn-secondary">بازگشت</button>
            </div>
            
            <div class="card">
                <h2>تایید/رد درخواست</h2>
                
                <div class="form-group">
                    <label for="request-nick">نام گیم:</label>
                    <input type="text" id="request-nick" placeholder="نام گیم متقاضی">
                </div>
                
                <div class="form-group">
                    <label for="request-referral">رفرال:</label>
                    <input type="text" id="request-referral" placeholder="کد رفرال متقاضی">
                </div>
                
                <div class="form-group">
                    <label for="request-tid">آیدی عددی تلگرام:</label>
                    <input type="number" id="request-tid" placeholder="آیدی عددی تلگرام متقاضی">
                </div>
                
                <div class="form-group">
                    <label for="request-status">نوع درخواست:</label>
                    <select id="request-status">
                        <option value="">-- انتخاب نوع --</option>
                        <option value="approved">تایید</option>
                        <option value="rejected">رد</option>
                    </select>
                </div>
                
                <div id="reject-reason-container" class="form-group hidden">
                    <label for="reject-reason">دلیل رد:</label>
                    <textarea id="reject-reason" rows="3" placeholder="دلیل رد درخواست"></textarea>
                </div>
                
                <div id="tester-container" class="form-group hidden">
                    <label for="tester">مسئول تست:</label>
                    <select id="tester">
                        <option value="">-- انتخاب مسئول تست --</option>
                    </select>
                </div>
                
                <button id="submit-decision-btn" class="btn">ثبت تصمیم</button>
            </div>
        </div>
        
        <!-- صفحه خطا -->
        <div id="error-page" class="hidden">
            <div class="card">
                <h2 class="error">خطا</h2>
                <p id="error-message"></p>
            </div>
        </div>
        
        <!-- صفحه لودینگ -->
        <div id="loading" class="loading">
            <p>در حال بارگذاری...</p>
        </div>
    </div>

    <script>
        // متغیرهای جهانی
        let currentUser = null;
        let isAdmin = false;
        let adminMeta = null;
        const API_BASE = 'https://rsm-helper.hupadr.workers.dev';
        
        // المنت های اصلی
        const mainPage = document.getElementById('main-page');
        const userPanel = document.getElementById('user-panel');
        const adminPanel = document.getElementById('admin-panel');
        const queryPage = document.getElementById('query-page');
        const appealPage = document.getElementById('appeal-page');
        const addAdminPage = document.getElementById('add-admin-page');
        const decideRequestPage = document.getElementById('decide-request-page');
        const errorPage = document.getElementById('error-page');
        const loadingElement = document.getElementById('loading');
        const errorMessageElement = document.getElementById('error-message');
        
        // نمایش خطا
        function showError(message) {
            errorMessageElement.textContent = message;
            hideAllPages();
            errorPage.classList.remove('hidden');
        }
        
        // پنهان کردن همه صفحات
        function hideAllPages() {
            mainPage.classList.add('hidden');
            userPanel.classList.add('hidden');
            adminPanel.classList.add('hidden');
            queryPage.classList.add('hidden');
            appealPage.classList.add('hidden');
            addAdminPage.classList.add('hidden');
            decideRequestPage.classList.add('hidden');
            errorPage.classList.add('hidden');
            loadingElement.classList.add('hidden');
        }
        
        // نمایش صفحه لودینگ
        function showLoading() {
            hideAllPages();
            loadingElement.classList.remove('hidden');
        }
        
        // بررسی اینکه آیا در محیط تلگرام هستیم یا نه
        function isTelegramWebApp() {
            return window.Telegram && window.Telegram.WebApp;
        }
        
        // دریافت initData از تلگرام
        function getInitData() {
            if (isTelegramWebApp()) {
                return window.Telegram.WebApp.initData;
            }
            return null;
        }
        
        // بررسی صحت initData با سرور
        async function verifyInitData() {
            const initData = getInitData();
            if (!initData) {
                throw new Error('داده‌های اولیه یافت نشد');
            }
            
            try {
                const response = await fetch(`${API_BASE}/api/verify-init`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ initData }),
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'خطا در تأیید هویت');
                }
                
                return data;
            } catch (error) {
                console.error('Error verifying init data:', error);
                throw new Error('خطا در ارتباط با سرور');
            }
        }
        
        // راه‌اندازی اولیه برنامه
        async function initializeApp() {
            // بررسی محیط اجرا
            if (!isTelegramWebApp()) {
                showError('این مینی‌اپ فقط داخل تلگرام کار می‌کند.');
                return;
            }
            
            showLoading();
            
            try {
                // تأیید initData
                const verificationResult = await verifyInitData();
                currentUser = verificationResult.user;
                isAdmin = verificationResult.is_admin;
                adminMeta = verificationResult.admin_meta;
                
                // نمایش پنل مناسب
                hideAllPages();
                mainPage.classList.remove('hidden');
                
                if (isAdmin) {
                    document.getElementById('admin-welcome').textContent = 
                        `خوش آمدید ${adminMeta.nick} (${adminMeta.rank})! رفرال: ${adminMeta.referral}`;
                    adminPanel.classList.remove('hidden');
                    
                    // مخفی کردن دکمه افزودن ادمین اگر دسترسی نداشته باشد
                    if (adminMeta.rank === 'Support Warden') {
                        document.getElementById('add-admin-btn').classList.add('hidden');
                    }
                } else {
                    document.getElementById('user-welcome').textContent = 
                        `خوش آمدید ${currentUser.first_name || 'کاربر'}!`;
                    userPanel.classList.remove('hidden');
                }
            } catch (error) {
                showError(error.message);
            }
        }
        
        // مدیریت ناوبری بین صفحات
        function setupNavigation() {
            // رفتن به صفحه استعلام
            document.getElementById('query-btn').addEventListener('click', () => {
                hideAllPages();
                queryPage.classList.remove('hidden');
            });
            
            // بازگشت از صفحه استعلام
            document.getElementById('back-from-query').addEventListener('click', () => {
                hideAllPages();
                mainPage.classList.remove('hidden');
                if (isAdmin) {
                    adminPanel.classList.remove('hidden');
                } else {
                    userPanel.classList.remove('hidden');
                }
            });
            
            // رفتن به صفحه افزودن ادمین
            document.getElementById('add-admin-btn').addEventListener('click', () => {
                hideAllPages();
                addAdminPage.classList.remove('hidden');
            });
            
            // بازگشت از صفحه افزودن ادمین
            document.getElementById('back-from-add-admin').addEventListener('click', () => {
                hideAllPages();
                mainPage.classList.remove('hidden');
                adminPanel.classList.remove('hidden');
            });
            
            // رفتن به صفحه تایید/رد درخواست
            document.getElementById('decide-request-btn').addEventListener('click', () => {
                hideAllPages();
                decideRequestPage.classList.remove('hidden');
                loadAdminsForTester();
            });
            
            // بازگشت از صفحه تایید/رد درخواست
            document.getElementById('back-from-decide').addEventListener('click', () => {
                hideAllPages();
                mainPage.classList.remove('hidden');
                adminPanel.classList.remove('hidden');
            });
            
            // بازگشت از صفحه اعتراض
            document.getElementById('back-from-appeal').addEventListener('click', () => {
                hideAllPages();
                queryPage.classList.remove('hidden');
            });
            
            // تغییر وضعیت درخواست (تایید/رد)
            document.getElementById('request-status').addEventListener('change', (e) => {
                const status = e.target.value;
                const rejectReasonContainer = document.getElementById('reject-reason-container');
                const testerContainer = document.getElementById('tester-container');
                
                if (status === 'rejected') {
                    rejectReasonContainer.classList.remove('hidden');
                    testerContainer.classList.add('hidden');
                } else if (status === 'approved') {
                    rejectReasonContainer.classList.add('hidden');
                    testerContainer.classList.remove('hidden');
                } else {
                    rejectReasonContainer.classList.add('hidden');
                    testerContainer.classList.add('hidden');
                }
            });
        }
        
        // بارگذاری ادمین‌ها برای dropdown مسئول تست
        async function loadAdminsForTester() {
            try {
                const response = await fetch(`${API_BASE}/api/list-admins`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'خطا در دریافت لیست ادمین‌ها');
                }
                
                const testerSelect = document.getElementById('tester');
                testerSelect.innerHTML = '<option value="">-- انتخاب مسئول تست --</option>';
                
                data.admins.forEach(admin => {
                    const option = document.createElement('option');
                    option.value = admin.nick;
                    option.textContent = `تست(${admin.nick}) - ${admin.rank}`;
                    testerSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading admins:', error);
            }
        }
        
        // ثبت ادمین جدید
        async function addNewAdmin() {
            const nick = document.getElementById('admin-nick').value;
            const referral = document.getElementById('admin-referral').value;
            const tid = document.getElementById('admin-tid').value;
            const rank = document.getElementById('admin-rank').value;
            
            if (!nick || !referral || !tid || !rank) {
                showError('لطفاً تمام فیلدها را پر کنید');
                return;
            }
            
            showLoading();
            
            try {
                const response = await fetch(`${API_BASE}/api/add-admin`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        nick,
                        referral,
                        telegram_id: tid,
                        rank
                    }),
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'خطا در افزودن ادمین');
                }
                
                // بازگشت به صفحه اصلی
                hideAllPages();
                mainPage.classList.remove('hidden');
                adminPanel.classList.remove('hidden');
                
                alert('ادمین با موفقیت افزوده شد');
            } catch (error) {
                showError(error.message);
            }
        }
        
        // ثبت تصمیم برای درخواست
        async function submitDecision() {
            const nick = document.getElementById('request-nick').value;
            const referral = document.getElementById('request-referral').value;
            const tid = document.getElementById('request-tid').value;
            const status = document.getElementById('request-status').value;
            const reason = document.getElementById('reject-reason').value;
            const tester = document.getElementById('tester').value;
            
            if (!nick || !referral || !tid || !status) {
                showError('لطفاً فیلدهای ضروری را پر کنید');
                return;
            }
            
            if (status === 'rejected' && !reason) {
                showError('لطفاً دلیل رد را وارد کنید');
                return;
            }
            
            if (status === 'approved' && !tester) {
                showError('لطفاً مسئول تست را انتخاب کنید');
                return;
            }
            
            showLoading();
            
            try {
                const response = await fetch(`${API_BASE}/api/decide`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        nick,
                        referral,
                        telegram_id: tid,
                        status,
                        reason: status === 'rejected' ? reason : null,
                        tester: status === 'approved' ? tester : null
                    }),
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'خطا در ثبت تصمیم');
                }
                
                // بازگشت به صفحه اصلی
                hideAllPages();
                mainPage.classList.remove('hidden');
                adminPanel.classList.remove('hidden');
                
                alert('تصمیم با موفقیت ثبت شد');
            } catch (error) {
                showError(error.message);
            }
        }
        
        // استعلام درخواست کاربر
        async function checkUserRequest() {
            const nick = document.getElementById('nick').value;
            const referral = document.getElementById('referral').value;
            
            if (!nick || !referral) {
                showError('لطفاً نام گیم و رفرال خود را وارد کنید');
                return;
            }
            
            showLoading();
            
            try {
                const response = await fetch(`${API_BASE}/api/query`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        nick,
                        referral
                    }),
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'خطا در استعلام درخواست');
                }
                
                hideAllPages();
                queryPage.classList.remove('hidden');
                
                const resultElement = document.getElementById('query-result');
                resultElement.classList.remove('hidden');
                
                if (!data.exists) {
                    resultElement.innerHTML = '<p>اطلاعات شما در دیتابیس یافت نشد.</p>';
                } else if (data.status === 'rejected') {
                    resultElement.innerHTML = `
                        <p>کاربر گرامی ${data.nick} با ${data.referral} متأسفانه رد شده‌اید.</p>
                        <p>دلیل: ${data.reason}</p>
                        <p>نگران نباشید؛ می‌توانید اعتراض ثبت کنید.</p>
                        <button id="appeal-btn" class="btn">اعتراض</button>
                    `;
                    
                    document.getElementById('appeal-btn').addEventListener('click', () => {
                        hideAllPages();
                        appealPage.classList.remove('hidden');
                    });
                } else if (data.status === 'approved') {
                    resultElement.innerHTML = `
                        <p>درخواست شما تأیید شده است!</p>
                        <p>مسئول تست: ${data.tester}</p>
                        <button id="ready-btn" class="btn">آماده‌ام</button>
                    `;
                    
                    document.getElementById('ready-btn').addEventListener('click', () => {
                        alert('به زودی با شما تماس گرفته خواهد شد');
                    });
                }
            } catch (error) {
                showError(error.message);
            }
        }
        
        // ثبت اعتراض کاربر
        async function submitAppeal() {
            const message = document.getElementById('appeal-message').value;
            
            if (!message) {
                showError('لطفاً متن اعتراض را وارد کنید');
                return;
            }
            
            showLoading();
            
            try {
                const nick = document.getElementById('nick').value;
                const referral = document.getElementById('referral').value;
                
                const response = await fetch(`${API_BASE}/api/appeal`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        nick,
                        referral,
                        message
                    }),
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'خطا در ثبت اعتراض');
                }
                
                hideAllPages();
                queryPage.classList.remove('hidden');
                
                const resultElement = document.getElementById('query-result');
                resultElement.classList.remove('hidden');
                resultElement.innerHTML = '<p class="success">اعتراض شما با موفقیت ثبت شد و به ادمین ارسال گردید.</p>';
            } catch (error) {
                showError(error.message);
            }
        }
        
        // راه‌اندازی برنامه پس از لود شدن صفحه
        document.addEventListener('DOMContentLoaded', () => {
            setupNavigation();
            
            // ثبت event listeners
            document.getElementById('submit-admin-btn').addEventListener('click', addNewAdmin);
            document.getElementById('submit-decision-btn').addEventListener('click', submitDecision);
            document.getElementById('check-request-btn').addEventListener('click', checkUserRequest);
            document.getElementById('submit-appeal-btn').addEventListener('click', submitAppeal);
            
            // شروع برنامه
            initializeApp();
        });
    </script>
</body>
</html>
